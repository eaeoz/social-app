<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blog Articles Manager</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f5f5f5;
      --bg-card: #ffffff;
      --text-primary: #1a1a1a;
      --text-secondary: #666666;
      --border-color: #e0e0e0;
      --accent: #667eea;
      --accent-hover: #5568d3;
      --success: #4CAF50;
      --danger: #f44336;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-card: #252525;
      --text-primary: #e0e0e0;
      --text-secondary: #a0a0a0;
      --border-color: #404040;
      --accent: #7c8adb;
      --accent-hover: #8b98e8;
      --shadow: rgba(0, 0, 0, 0.3);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }

    .container {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: white;
      padding: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      -webkit-app-region: drag;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
    }

    .header h1 {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 0.3px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      -webkit-app-region: no-drag;
    }

    .theme-toggle {
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.8);
      font-size: 18px;
      cursor: pointer;
      padding: 14px 16px;
      transition: all 0.2s;
      height: 100%;
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .header-btn {
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      padding: 14px 16px;
      transition: all 0.2s;
      font-size: 13px;
      font-weight: 500;
      height: 100%;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .header-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .header-btn.close-btn {
      color: rgba(255, 255, 255, 0.7);
      font-size: 20px;
      padding: 14px 20px;
    }

    .header-btn.close-btn:hover {
      background: #e74c3c;
      color: white;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--success);
      color: white;
    }

    .btn-primary:hover {
      opacity: 0.9;
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .config-banner {
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .config-banner h4 {
      margin-bottom: 12px;
      font-size: 16px;
    }

    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .config-item label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-secondary);
    }

    .config-item input {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 13px;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .search-section {
      flex-shrink: 0;
    }

    .search-input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      font-size: 15px;
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .articles-grid {
      display: grid;
      gap: 20px;
    }

    .article-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .article-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .article-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      gap: 15px;
    }

    .article-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      flex: 1;
    }

    .article-logo {
      font-size: 32px;
    }

    .article-info {
      flex: 1;
    }

    .article-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .article-author {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .article-date {
      font-size: 13px;
      color: var(--text-secondary);
      background: var(--bg-secondary);
      padding: 4px 10px;
      border-radius: 12px;
    }

    .article-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 15px;
    }

    .tag-badge {
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .article-content {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text-primary);
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-bottom: 15px;
    }

    .article-actions {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      background: var(--bg-secondary);
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 5px;
      transition: all 0.2s;
    }

    .btn-icon:hover {
      background: var(--border-color);
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      padding: 15px 0;
      flex-shrink: 0;
    }

    .pagination button {
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      color: var(--text-primary);
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
    }

    .pagination button:hover:not(:disabled) {
      background: var(--bg-secondary);
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 10px;
      width: 90vw;
      max-width: 1200px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .modal-header h3 {
      font-size: 18px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: var(--danger);
      color: white;
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 20px;
      padding-bottom: 0;
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .modal-body form {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }

    .modal-body form > *:not(.form-actions) {
      flex-shrink: 0;
    }

    /* Hide scrollbars */
    .modal-body::-webkit-scrollbar,
    .content::-webkit-scrollbar,
    .reader-content::-webkit-scrollbar {
      display: none;
    }

    .modal-body,
    .content,
    .reader-content {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .form-group {
      margin-bottom: 10px;
    }

    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 12px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 2px solid var(--border-color);
      border-radius: 5px;
      font-size: 13px;
      font-family: inherit;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .form-group input {
      min-height: 36px;
    }

    .form-group textarea {
      resize: vertical;
    }

    #articleExcerpt {
      min-height: 50px;
      max-height: 80px;
    }

    #articleContent {
      min-height: calc(90vh - 480px);
      max-height: calc(90vh - 400px);
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    }

    .form-compact {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }

    .form-compact .form-group {
      margin-bottom: 0;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-row {
      display: grid;
      grid-template-columns: 3fr 1fr;
      gap: 12px;
    }

    .tags-input-container {
      display: flex;
      gap: 8px;
    }

    .tags-input-container input {
      flex: 1;
    }

    .tags-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .tag-item {
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .tag-item button {
      background: none;
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 14px;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 15px 20px;
      margin: 0 -20px;
      border-top: 1px solid var(--border-color);
      background: var(--bg-card);
      position: sticky;
      bottom: 0;
      z-index: 10;
      flex-shrink: 0;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--bg-card);
      padding: 12px 16px;
      border-radius: 6px;
      box-shadow: 0 4px 12px var(--shadow);
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 2000;
      font-size: 13px;
      border: 1px solid var(--border-color);
    }

    .notification-success {
      border-left: 4px solid var(--success);
    }

    .notification-error {
      border-left: 4px solid var(--danger);
    }

    .loading {
      text-align: center;
      padding: 60px;
    }

    .spinner {
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 15px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    /* Fullscreen Reader Modal */
    .reader-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-primary);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .reader-header {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: white;
      padding: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .reader-header-left {
      display: flex;
      align-items: center;
      padding: 14px 20px;
    }

    .reader-header h2 {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 0.3px;
    }

    .reader-close {
      position: fixed;
      top: 80px;
      right: 40px;
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      color: var(--text-primary);
      font-size: 24px;
      cursor: pointer;
      padding: 12px 16px;
      border-radius: 50%;
      transition: all 0.2s;
      z-index: 1000;
      box-shadow: 0 4px 12px var(--shadow);
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .reader-close:hover {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
      transform: rotate(90deg) scale(1.1);
    }

    .reader-content {
      flex: 1;
      overflow-y: auto;
      padding: 40px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }

    .reader-meta {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
    }

    .reader-logo {
      font-size: 48px;
    }

    .reader-info h1 {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 10px;
    }

    .reader-details {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .reader-author {
      font-size: 16px;
      color: var(--text-secondary);
    }

    .reader-date {
      font-size: 14px;
      color: var(--text-secondary);
      background: var(--bg-secondary);
      padding: 5px 12px;
      border-radius: 15px;
    }

    .reader-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 30px;
    }

    .reader-tag {
      background: var(--accent);
      color: white;
      padding: 6px 14px;
      border-radius: 15px;
      font-size: 13px;
      font-weight: 500;
    }

    .reader-body {
      font-size: 17px;
      line-height: 1.8;
      color: var(--text-primary);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* Date Picker Popup */
    .date-picker-popup {
      position: absolute;
      background: var(--bg-card);
      border: 2px solid var(--accent);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 8px 24px var(--shadow);
      z-index: 10001;
      min-width: 280px;
    }

    .date-picker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .date-picker-header button {
      background: var(--bg-secondary);
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-primary);
    }

    .date-picker-header button:hover {
      background: var(--border-color);
    }

    .date-picker-title {
      font-weight: 600;
      font-size: 14px;
    }

    .date-picker-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .date-picker-day-name {
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      padding: 6px;
    }

    .date-picker-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .date-picker-day:hover {
      background: var(--bg-secondary);
    }

    .date-picker-day.today {
      border-color: var(--accent);
      font-weight: 600;
    }

    .date-picker-day.selected {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .date-picker-day.other-month {
      color: var(--text-secondary);
      opacity: 0.5;
    }

    .date-picker-day.disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .date-picker-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .date-picker-actions button {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1>üìù Blog Manager</h1>
      </div>
      <div class="header-actions">
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">üåì</button>
        <button class="header-btn" onclick="openConfigModal()">‚öôÔ∏è Config</button>
        <button class="header-btn" onclick="openNewArticleModal()">‚ûï New Article</button>
        <button class="header-btn close-btn" onclick="closeWindow()" title="Close">‚úï</button>
      </div>
    </div>

    <div class="content">
      <div id="loadingState" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Loading articles...</p>
      </div>

      <div id="articlesView" style="display: none;">
        <div class="search-section">
          <input type="text" class="search-input" id="searchInput" placeholder="üîç Search articles..." oninput="filterArticles()">
        </div>

        <div class="articles-grid" id="articlesGrid"></div>

        <div class="pagination">
          <button onclick="prevPage()" id="prevBtn">‚Üê Previous</button>
          <span id="pageInfo">Page 1 of 1</span>
          <button onclick="nextPage()" id="nextBtn">Next ‚Üí</button>
        </div>
      </div>

      <div id="emptyState" class="empty-state" style="display: none;">
        <div class="empty-icon">üìù</div>
        <h3>No Articles Yet</h3>
        <p>Create your first blog article</p>
        <button class="btn btn-primary" onclick="openNewArticleModal()">‚ûï Create Article</button>
      </div>
    </div>
  </div>

  <div id="articleModal" class="modal-overlay" style="display: none;" onclick="closeModalOnOverlay(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 id="modalTitle">‚ûï New Article</h3>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body">
        <form id="articleForm" onsubmit="saveArticle(event)">
          <div class="form-compact">
            <div class="form-group">
              <label>Title *</label>
              <input type="text" id="articleTitle" required>
            </div>
            <div class="form-group">
              <label>Logo</label>
              <input type="text" id="articleLogo" value="üìù" maxlength="10">
            </div>
            <div class="form-group">
              <label>Author *</label>
              <input type="text" id="articleAuthor" required>
            </div>
            <div class="form-group">
              <label>Date *</label>
              <input type="date" id="articleDate" required>
            </div>
          </div>

          <div class="form-group">
            <label>Tags</label>
            <div class="tags-input-container">
              <input type="text" id="tagInput" placeholder="Tag name" onkeypress="handleTagInput(event)">
              <button type="button" class="btn btn-secondary" onclick="addTag()">Add</button>
            </div>
            <div class="tags-list" id="tagsList"></div>
          </div>

          <div class="form-group">
            <label>Excerpt (Short preview, max 500 chars) *</label>
            <textarea id="articleExcerpt" maxlength="500" required></textarea>
          </div>

          <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
            <label>Content (Supports Markdown) *</label>
            <textarea id="articleContent" required style="flex: 1;"></textarea>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" id="saveButton">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Configuration Modal -->
  <div id="configModal" class="modal-overlay" style="display: none;" onclick="closeConfigModalOnOverlay(event)">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
      <div class="modal-header">
        <h3>‚öôÔ∏è Configuration Manager</h3>
        <button class="modal-close" onclick="closeConfigModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Appwrite Endpoint</label>
          <input type="text" id="configEndpoint" placeholder="https://cloud.appwrite.io/v1">
        </div>
        <div class="form-group">
          <label>Project ID</label>
          <input type="text" id="configProject" placeholder="Your project ID">
        </div>
        <div class="form-group">
          <label>Database ID</label>
          <input type="text" id="configDatabase" placeholder="Database ID">
        </div>
        <div class="form-group">
          <label>Collection ID</label>
          <input type="text" id="configCollection" placeholder="Collection ID">
        </div>
        
        <div style="border-top: 1px solid var(--border-color); margin: 20px 0; padding-top: 20px;">
          <h4 style="margin-bottom: 12px; font-size: 14px;">Backup & Restore</h4>
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button class="btn btn-primary" onclick="backupConfig()" style="flex: 1;">
              üíæ Backup Configuration
            </button>
            <button class="btn btn-secondary" onclick="document.getElementById('restoreInput').click()" style="flex: 1;">
              üìÇ Restore Configuration
            </button>
          </div>
          <input type="file" id="restoreInput" accept=".json" style="display: none;" onchange="restoreConfig(event)">
          <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
            Backup saves all settings including theme preferences to config.json
          </p>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeConfigModal()">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveConfigFromModal()">Save & Connect</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Fullscreen Reader Modal -->
  <div id="readerModal" class="reader-modal" style="display: none;">
    <div class="reader-header">
      <div class="reader-header-left">
        <h2 id="readerTitle">üìñ Reading Article</h2>
      </div>
      <button class="reader-close" onclick="closeReader()" title="Close">‚úï</button>
    </div>
    <div class="reader-content">
      <div class="reader-meta">
        <span class="reader-logo" id="readerLogo">üìù</span>
        <div class="reader-info">
          <h1 id="readerArticleTitle">Article Title</h1>
          <div class="reader-details">
            <span class="reader-author" id="readerAuthor">by Author</span>
            <span class="reader-date" id="readerDate">2024-01-01</span>
          </div>
        </div>
      </div>
      <div class="reader-tags" id="readerTags"></div>
      <div class="reader-body" id="readerBody"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    const ITEMS_PER_PAGE = 5;
    
    let client, databases;
    let articles = [];
    let filteredArticles = [];
    let currentArticle = null;
    let currentTags = [];
    let currentPage = 1;
    let config = {};

    window.onload = () => {
      loadConfig();
      applyTheme();
    };

    function loadConfig() {
      config = {
        endpoint: localStorage.getItem('appwrite_endpoint') || '',
        project: localStorage.getItem('appwrite_project') || '',
        databaseId: localStorage.getItem('database_id') || '',
        collectionId: localStorage.getItem('collection_id') || '',
        theme: localStorage.getItem('theme') || 'light'
      };

      // Only initialize if we have configuration
      if (config.project && config.endpoint && config.databaseId && config.collectionId) {
        initAppwrite(config);
      } else {
        // Show empty state - need configuration
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('articlesView').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('emptyState').innerHTML = `
          <div class="empty-icon">‚öôÔ∏è</div>
          <h3>No Configuration Found</h3>
          <p>Please configure your Appwrite connection</p>
          <button class="btn btn-primary" onclick="openConfigModal()">‚öôÔ∏è Open Configuration</button>
        `;
      }
    }

    function toggleTheme() {
      config.theme = config.theme === 'light' ? 'dark' : 'light';
      localStorage.setItem('theme', config.theme);
      applyTheme();
    }

    function applyTheme() {
      document.body.setAttribute('data-theme', config.theme);
    }

    function closeWindow() {
      if (window.require) {
        // Electron environment
        const { remote } = window.require('electron');
        const win = remote.getCurrentWindow();
        win.close();
      } else {
        // Browser environment - close tab/window
        window.close();
      }
    }

    function initAppwrite(cfg) {
      const { Client, Databases, Query, ID } = Appwrite;
      client = new Client().setEndpoint(cfg.endpoint).setProject(cfg.project);
      
      databases = new Databases(client);
      window.AppwriteQuery = Query;
      window.AppwriteID = ID;

      loadArticles();
    }

    async function loadArticles() {
      document.getElementById('loadingState').style.display = 'block';
      document.getElementById('articlesView').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';

      try {
        const response = await databases.listDocuments(config.databaseId, config.collectionId, [
          window.AppwriteQuery.orderDesc('$createdAt'),
          window.AppwriteQuery.limit(100)
        ]);

        articles = response.documents.map(doc => ({
          $id: doc.$id,
          id: doc.articleId,
          title: doc.title,
          author: doc.author,
          date: doc.date,
          tags: typeof doc.tags === 'string' ? JSON.parse(doc.tags) : doc.tags,
          logo: doc.logo,
          excerpt: doc.excerpt,
          content: doc.content
        }));

        filteredArticles = [...articles];
        currentPage = 1;
        renderArticles();
        document.getElementById('loadingState').style.display = 'none';
      } catch (error) {
        document.getElementById('loadingState').style.display = 'none';
        showNotification('Load failed: ' + error.message, 'error');
      }
    }

    function renderArticles() {
      const grid = document.getElementById('articlesGrid');
      grid.innerHTML = '';

      if (filteredArticles.length === 0) {
        document.getElementById('articlesView').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        return;
      }

      document.getElementById('articlesView').style.display = 'block';
      document.getElementById('emptyState').style.display = 'none';

      const start = (currentPage - 1) * ITEMS_PER_PAGE;
      const end = start + ITEMS_PER_PAGE;
      const pageArticles = filteredArticles.slice(start, end);

      pageArticles.forEach(article => {
        const card = document.createElement('div');
        card.className = 'article-card';
        card.innerHTML = `
          <div class="article-header">
            <div class="article-meta">
              <span class="article-logo">${article.logo}</span>
              <div class="article-info">
                <div class="article-title" onclick='viewArticle(${JSON.stringify(article).replace(/'/g, "&#39;")})' style="cursor: pointer;" title="Click to read">${escapeHtml(article.title)}</div>
                <div class="article-author">by ${escapeHtml(article.author)}</div>
              </div>
              <span class="article-date">${article.date}</span>
            </div>
            <div class="article-actions">
              <button class="btn-icon" onclick='editArticle(${JSON.stringify(article).replace(/'/g, "&#39;")})' title="Edit">‚úèÔ∏è</button>
              <button class="btn-icon" onclick='deleteArticle("${article.$id}")' title="Delete">üóëÔ∏è</button>
            </div>
          </div>
          ${article.tags.length > 0 ? `
            <div class="article-tags">
              ${article.tags.map(tag => `<span class="tag-badge">${escapeHtml(tag)}</span>`).join('')}
            </div>
          ` : ''}
          <div class="article-content">${escapeHtml(article.excerpt)}</div>
        `;
        grid.appendChild(card);
      });

      updatePagination();
    }

    function updatePagination() {
      const totalPages = Math.ceil(filteredArticles.length / ITEMS_PER_PAGE);
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage === totalPages;
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderArticles();
        document.querySelector('.content').scrollTop = 0;
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(filteredArticles.length / ITEMS_PER_PAGE);
      if (currentPage < totalPages) {
        currentPage++;
        renderArticles();
        document.querySelector('.content').scrollTop = 0;
      }
    }

    function filterArticles() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      if (query.length < 3) {
        filteredArticles = [...articles];
      } else {
        filteredArticles = articles.filter(article => 
          article.title.toLowerCase().includes(query) ||
          article.author.toLowerCase().includes(query) ||
          article.content.toLowerCase().includes(query) ||
          article.tags.some(tag => tag.toLowerCase().includes(query))
        );
      }
      currentPage = 1;
      renderArticles();
    }

    function openNewArticleModal() {
      currentArticle = null;
      currentTags = [];
      document.getElementById('modalTitle').textContent = '‚ûï New Article';
      document.getElementById('saveButton').textContent = 'Create';
      document.getElementById('articleForm').reset();
      document.getElementById('articleDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('articleLogo').value = 'üìù';
      document.getElementById('tagsList').innerHTML = '';
      document.getElementById('articleModal').style.display = 'flex';
    }

    function editArticle(article) {
      currentArticle = article;
      currentTags = [...article.tags];
      document.getElementById('modalTitle').textContent = '‚úèÔ∏è Edit Article';
      document.getElementById('saveButton').textContent = 'Update';
      
      document.getElementById('articleTitle').value = article.title;
      document.getElementById('articleAuthor').value = article.author;
      document.getElementById('articleDate').value = article.date;
      document.getElementById('articleLogo').value = article.logo;
      document.getElementById('articleExcerpt').value = article.excerpt;
      document.getElementById('articleContent').value = article.content;
      
      renderTags();
      document.getElementById('articleModal').style.display = 'flex';
    }

    async function deleteArticle(docId) {
      if (!confirm('Delete this article?')) return;
      
      try {
        await databases.deleteDocument(config.databaseId, config.collectionId, docId);
        showNotification('Deleted!', 'success');
        await loadArticles();
      } catch (error) {
        showNotification('Delete failed', 'error');
      }
    }

    async function saveArticle(event) {
      event.preventDefault();
      
      console.log('=== Save Article Debug ===');
      console.log('1. Function called');
      console.log('2. databases:', databases);
      console.log('3. config:', config);

      // Check if Appwrite is configured
      if (!databases || !config.databaseId || !config.collectionId) {
        console.error('Appwrite not configured!');
        alert('ERROR: Please configure Appwrite connection first!\n\nGo to Config button and enter your Appwrite details.');
        showNotification('Please configure Appwrite connection first', 'error');
        return;
      }

      console.log('4. Configuration OK');

      const articleData = {
        articleId: currentArticle?.id || Date.now().toString(),
        title: document.getElementById('articleTitle').value.trim(),
        author: document.getElementById('articleAuthor').value.trim(),
        date: document.getElementById('articleDate').value,
        tags: JSON.stringify(currentTags),
        logo: document.getElementById('articleLogo').value.trim() || 'üìù',
        excerpt: document.getElementById('articleExcerpt').value.trim(),
        content: document.getElementById('articleContent').value.trim()
      };

      console.log('5. Article data:', articleData);

      // Disable button while saving
      const saveButton = document.getElementById('saveButton');
      const originalText = saveButton.textContent;
      saveButton.disabled = true;
      saveButton.textContent = 'Saving...';
      
      console.log('6. Button disabled, starting save...');

      try {
        let result;
        if (currentArticle) {
          console.log('7. Updating existing article...');
          result = await databases.updateDocument(config.databaseId, config.collectionId, currentArticle.$id, articleData);
          console.log('8. Update successful:', result);
          showNotification('Article updated successfully!', 'success');
        } else {
          console.log('7. Creating new article...');
          result = await databases.createDocument(config.databaseId, config.collectionId, window.AppwriteID.unique(), articleData);
          console.log('8. Create successful:', result);
          showNotification('Article created successfully!', 'success');
        }

        console.log('9. Closing modal...');
        closeModal();
        
        console.log('10. Reloading articles...');
        await loadArticles();
        
        console.log('11. All done!');
      } catch (error) {
        console.error('=== SAVE ERROR ===');
        console.error('Error object:', error);
        console.error('Error message:', error.message);
        console.error('Error type:', error.type);
        console.error('Error code:', error.code);
        console.error('Full error:', JSON.stringify(error, null, 2));
        
        alert('SAVE FAILED!\n\nError: ' + (error.message || 'Unknown error') + '\n\nCheck browser console (F12) for details.');
        showNotification('Save failed: ' + (error.message || 'Unknown error'), 'error');
        
        // Re-enable button on error
        saveButton.disabled = false;
        saveButton.textContent = originalText;
      }
    }

    function handleTagInput(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        addTag();
      }
    }

    function addTag() {
      const input = document.getElementById('tagInput');
      const tag = input.value.trim();
      
      if (tag && !currentTags.includes(tag)) {
        currentTags.push(tag);
        renderTags();
        input.value = '';
      }
    }

    function removeTag(tag) {
      currentTags = currentTags.filter(t => t !== tag);
      renderTags();
    }

    function renderTags() {
      const tagsList = document.getElementById('tagsList');
      tagsList.innerHTML = currentTags.map(tag => `
        <span class="tag-item">
          ${escapeHtml(tag)}
          <button type="button" onclick='removeTag("${escapeHtml(tag)}")'>√ó</button>
        </span>
      `).join('');
    }

    function viewArticle(article) {
      document.getElementById('readerLogo').textContent = article.logo;
      document.getElementById('readerArticleTitle').textContent = article.title;
      document.getElementById('readerAuthor').textContent = `by ${article.author}`;
      document.getElementById('readerDate').textContent = article.date;
      
      const tagsContainer = document.getElementById('readerTags');
      if (article.tags.length > 0) {
        tagsContainer.innerHTML = article.tags.map(tag => 
          `<span class="reader-tag">${escapeHtml(tag)}</span>`
        ).join('');
        tagsContainer.style.display = 'flex';
      } else {
        tagsContainer.style.display = 'none';
      }
      
      // Render markdown as HTML
      const readerBody = document.getElementById('readerBody');
      if (typeof marked !== 'undefined') {
        readerBody.innerHTML = marked.parse(article.content);
      } else {
        readerBody.textContent = article.content;
      }
      
      document.getElementById('readerModal').style.display = 'flex';
    }

    function closeReader() {
      document.getElementById('readerModal').style.display = 'none';
    }

    function closeModal() {
      // Close date picker if open
      if (datePickerState.pickerElement) {
        closeDatePickerOnOutsideClick();
      }
      document.getElementById('articleModal').style.display = 'none';
    }

    function closeModalOnOverlay(event) {
      if (event.target.className === 'modal-overlay') closeModal();
    }

    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.innerHTML = `
        <span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
        <span>${escapeHtml(message)}</span>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 2000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Date Picker Functionality
    let datePickerState = {
      currentDate: new Date(),
      selectedDate: null,
      inputElement: null,
      pickerElement: null
    };

    function showDatePicker(inputElement) {
      // Remove existing picker
      if (datePickerState.pickerElement) {
        datePickerState.pickerElement.remove();
      }

      datePickerState.inputElement = inputElement;
      
      // Parse current value or use today
      if (inputElement.value) {
        datePickerState.selectedDate = new Date(inputElement.value + 'T00:00:00');
        datePickerState.currentDate = new Date(inputElement.value + 'T00:00:00');
      } else {
        datePickerState.selectedDate = new Date();
        datePickerState.currentDate = new Date();
      }

      // Create picker
      const picker = document.createElement('div');
      picker.className = 'date-picker-popup';
      picker.onclick = (e) => e.stopPropagation();

      // Position picker
      const rect = inputElement.getBoundingClientRect();
      picker.style.position = 'fixed';
      picker.style.left = rect.left + 'px';
      picker.style.top = (rect.bottom + 5) + 'px';

      renderDatePicker(picker);
      document.body.appendChild(picker);
      datePickerState.pickerElement = picker;

      // Close on outside click
      setTimeout(() => {
        document.addEventListener('click', closeDatePickerOnOutsideClick);
      }, 0);
    }

    function closeDatePickerOnOutsideClick() {
      if (datePickerState.pickerElement) {
        datePickerState.pickerElement.remove();
        datePickerState.pickerElement = null;
      }
      document.removeEventListener('click', closeDatePickerOnOutsideClick);
    }

    function renderDatePicker(container) {
      const year = datePickerState.currentDate.getFullYear();
      const month = datePickerState.currentDate.getMonth();
      
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
      const dayNames = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];

      container.innerHTML = `
        <div class="date-picker-header">
          <button type="button" onclick="changeMonth(-1)">‚Äπ</button>
          <div class="date-picker-title">${monthNames[month]} ${year}</div>
          <button type="button" onclick="changeMonth(1)">‚Ä∫</button>
        </div>
        <div class="date-picker-grid">
          ${dayNames.map(day => `<div class="date-picker-day-name">${day}</div>`).join('')}
          ${generateCalendarDays(year, month)}
        </div>
        <div class="date-picker-actions">
          <button type="button" class="btn btn-secondary" onclick="selectToday()">Today</button>
          <button type="button" class="btn btn-primary" onclick="closeDatePicker()">Done</button>
        </div>
      `;
    }

    function generateCalendarDays(year, month) {
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const daysInPrevMonth = new Date(year, month, 0).getDate();
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      let html = '';
      
      // Previous month days
      for (let i = firstDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        html += `<div class="date-picker-day other-month" onclick="selectPrevMonthDay(${day})">${day}</div>`;
      }
      
      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        date.setHours(0, 0, 0, 0);
        
        let classes = ['date-picker-day'];
        
        if (date.getTime() === today.getTime()) {
          classes.push('today');
        }
        
        if (datePickerState.selectedDate && 
            date.getTime() === new Date(datePickerState.selectedDate).setHours(0, 0, 0, 0)) {
          classes.push('selected');
        }
        
        html += `<div class="${classes.join(' ')}" onclick="selectDay(${day})">${day}</div>`;
      }
      
      // Next month days to fill grid
      const totalCells = firstDay + daysInMonth;
      const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      
      for (let day = 1; day <= remainingCells; day++) {
        html += `<div class="date-picker-day other-month" onclick="selectNextMonthDay(${day})">${day}</div>`;
      }
      
      return html;
    }

    function changeMonth(delta) {
      datePickerState.currentDate.setMonth(datePickerState.currentDate.getMonth() + delta);
      renderDatePicker(datePickerState.pickerElement);
    }

    function selectDay(day) {
      datePickerState.selectedDate = new Date(
        datePickerState.currentDate.getFullYear(),
        datePickerState.currentDate.getMonth(),
        day
      );
      renderDatePicker(datePickerState.pickerElement);
    }

    function selectPrevMonthDay(day) {
      changeMonth(-1);
      selectDay(day);
    }

    function selectNextMonthDay(day) {
      changeMonth(1);
      selectDay(day);
    }

    function selectToday() {
      const today = new Date();
      datePickerState.selectedDate = today;
      datePickerState.currentDate = new Date(today);
      renderDatePicker(datePickerState.pickerElement);
    }

    function closeDatePicker() {
      if (datePickerState.selectedDate && datePickerState.inputElement) {
        const year = datePickerState.selectedDate.getFullYear();
        const month = String(datePickerState.selectedDate.getMonth() + 1).padStart(2, '0');
        const day = String(datePickerState.selectedDate.getDate()).padStart(2, '0');
        datePickerState.inputElement.value = `${year}-${month}-${day}`;
      }
      closeDatePickerOnOutsideClick();
    }

    // Make date input read-only and add click handler
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        const dateInput = document.getElementById('articleDate');
        if (dateInput) {
          dateInput.readOnly = true;
          dateInput.style.cursor = 'pointer';
          dateInput.addEventListener('click', (e) => {
            e.stopPropagation();
            showDatePicker(dateInput);
          });
        }
      }, 100);
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        if (datePickerState.pickerElement) {
          closeDatePickerOnOutsideClick();
        } else if (document.getElementById('articleModal').style.display === 'flex') {
          closeModal();
        } else if (document.getElementById('configModal').style.display === 'flex') {
          closeConfigModal();
        }
      }
    });

    // Configuration Modal Functions
    function openConfigModal() {
      // Always read fresh from localStorage
      const storedEndpoint = localStorage.getItem('appwrite_endpoint') || '';
      const storedProject = localStorage.getItem('appwrite_project') || '';
      const storedDatabase = localStorage.getItem('database_id') || '';
      const storedCollection = localStorage.getItem('collection_id') || '';
      
      document.getElementById('configEndpoint').value = storedEndpoint;
      document.getElementById('configProject').value = storedProject;
      document.getElementById('configDatabase').value = storedDatabase;
      document.getElementById('configCollection').value = storedCollection;
      
      document.getElementById('configModal').style.display = 'flex';
    }

    function closeConfigModal() {
      document.getElementById('configModal').style.display = 'none';
    }

    function closeConfigModalOnOverlay(event) {
      if (event.target.id === 'configModal') closeConfigModal();
    }

    function saveConfigFromModal() {
      const endpoint = document.getElementById('configEndpoint').value.trim();
      const project = document.getElementById('configProject').value.trim();
      const database = document.getElementById('configDatabase').value.trim();
      const collection = document.getElementById('configCollection').value.trim();

      if (!endpoint || !project || !database || !collection) {
        showNotification('All fields are required', 'error');
        return;
      }

      // Save to localStorage
      localStorage.setItem('appwrite_endpoint', endpoint);
      localStorage.setItem('appwrite_project', project);
      localStorage.setItem('database_id', database);
      localStorage.setItem('collection_id', collection);

      // Update config object
      config.endpoint = endpoint;
      config.project = project;
      config.databaseId = database;
      config.collectionId = collection;

      // Initialize Appwrite
      initAppwrite(config);
      
      closeConfigModal();
      showNotification('Configuration saved!', 'success');
    }

    function backupConfig() {
      const backup = {
        endpoint: localStorage.getItem('appwrite_endpoint') || config.endpoint || '',
        project: localStorage.getItem('appwrite_project') || config.project || '',
        databaseId: localStorage.getItem('database_id') || config.databaseId || '',
        collectionId: localStorage.getItem('collection_id') || config.collectionId || '',
        theme: localStorage.getItem('theme') || config.theme || 'light'
      };

      const dataStr = JSON.stringify(backup, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'blog-manager-config.json';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      showNotification('Configuration backed up!', 'success');
    }

    function restoreConfig(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const backup = JSON.parse(e.target.result);
          
          // Validate backup structure
          if (!backup.endpoint || !backup.project || !backup.databaseId || !backup.collectionId) {
            showNotification('Invalid configuration file', 'error');
            return;
          }

          // Restore to localStorage
          localStorage.setItem('appwrite_endpoint', backup.endpoint);
          localStorage.setItem('appwrite_project', backup.project);
          localStorage.setItem('database_id', backup.databaseId);
          localStorage.setItem('collection_id', backup.collectionId);
          localStorage.setItem('theme', backup.theme || 'light');

          // Update config object
          config.endpoint = backup.endpoint;
          config.project = backup.project;
          config.databaseId = backup.databaseId;
          config.collectionId = backup.collectionId;
          config.theme = backup.theme || 'light';

          // Apply theme
          applyTheme();

          // Update modal fields
          document.getElementById('configEndpoint').value = backup.endpoint;
          document.getElementById('configProject').value = backup.project;
          document.getElementById('configDatabase').value = backup.databaseId;
          document.getElementById('configCollection').value = backup.collectionId;

          showNotification('Configuration restored!', 'success');

          // Initialize Appwrite with restored config
          if (backup.project) {
            initAppwrite(config);
          }
        } catch (error) {
          showNotification('Failed to restore configuration', 'error');
        }
      };
      reader.readAsText(file);
      
      // Reset file input
      event.target.value = '';
    }
  </script>
</body>
</html>
